containers:
  base:
    setup:
      - !Ubuntu trusty
      - !UbuntuUniverse
      - !AptTrust keys: [5BB92C09DB82666C]
      - !UbuntuPPA fkrull/deadsnakes
      - !Install
        - software-properties-common
        - python3.5
        - python3.5-dev
        - openssl
        - libssl-dev
        - libpq-dev
        - ca-certificates
        - build-essential
      - !PipConfig
        dependencies: true
        python-exe: python3.5
      - !NpmInstall [bower]

  gdg-devel:
    setup:
      - !Container base
      - !EnsureDir /var/tmp/run
      - !BuildDeps
        - git
        - mercurial
      - !PipConfig
        dependencies: true
        python-exe: python3.5
      - !Depends requirements/common.txt  # As to https://github.com/tailhook/vagga/issues/236
      - !Py3Requirements requirements/dev.txt
    environ:
      APP_ROOT: /work  # Make sure this is not overriden by .exports
    volumes:
      /var/tmp/run: !Tmpfs
        size: 5Mi
        mode: 0o1777

  gdg-test:
    setup:
      - !Container base
      - !BuildDeps
        - git
        - mercurial
      - !Depends requirements/common.txt
      - !Depends requirements/dev.txt
      - !Py3Requirements requirements/test.txt
      - !Py3Requirements requirements/test-env.txt
    environ:
      BLUEBERRYPY_CONFIG: "{}"
      NOSE_TESTCONFIG_AUTOLOAD_YAML: "config/test/app.yml"

commands:
  run: !Supervise
    description: Run application in development mode
    children:
      run-app: !Command
        container: gdg-devel
        run:
          if test -f ./.exports; then . ./.exports; fi &&
          blueberrypy serve -b 0.0.0.0:8080 -P /var/run/gdg.org.ua.development.pid
  nose: !Command
    description: Run nosetests for gdg.org.ua project
    container: gdg-test
    run: nosetests -w src/tests --tests=test_utils
